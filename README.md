# Требования

Разработать систему мониторинга списка администраторов группы VK. При изменениях
отправлять оповещения в Splunk и в один из мессенджеров (на выбор). Язык
разработки Pyhton. Компоненты сервиса упаковать в контейнеры Docker и настроить
запуск через Docker Compose.

_Уточнение:_ администраторами группы считаются привилегированные пользователи с
ролями `creator` и `administrator`. Пользователи с ролями `moderator` и `editor`
к администраторам не относятся.

# Описание реализации

## Общая логика работы

Центральным элементом системы является скрипт мониторинга `vkgrpmon.py`,
предназначенный для периодических запусков по определенному расписанию.

Скрипт обращается к VK Groups API, получает текущий список администраторов
группы, и сравнивает его со списком, сохраненным при предыдущем запуске скрипта.
В результате сравнения формируются списки добавленных и удаленных пользователей.
Информация об этих пользователях дополняется отображаемым именем, получаемым из
VK Users API.

Нотификации об изменениях в списке администраторов группы направляются в Slack и
в Splunk (при отсутствии изменений нотификации направлены не будут). После
отправки нотификаций список администраторов группы сохраняется в файле на диске.

Непосредственно перед завершением работы скрипта в Splunk отправляется событие,
подтверждающее успешное окончание цикла мониторинга.

## Интеграция с VK API

Для интеграции используется VK HTTP API без сторонних библиотек. Аутентификация
запросов осуществляется путем передачи `access_token` в параметрах запроса.
Токен должен обладать правами на просмотр администраторов сообщества.

## Интеграция с Splunk

События передаются по протоколу TCP в простом текстовом формате. Разделителем
событий служит символ переноса строки. Каждое событие представляется в виде
пар `key="value"`, разделенных пробелами.

В случае, если за период между запусками скрипта мониторинга произошло несколько
изменений в списке администраторов группы VK, то в Splunk будет отправлено
несколько событий – по одному на каждого добавленного или удаленного
пользователя. Все события, созданные в рамках одного цикла мониторинга,
отправляются с одинаковыми значениями `timestamp`, соответствующими моменту
начала цикла.

Все события содержат следующие поля:

* `timestamp` – метка времени в формате epoch time с дробными значениями секунд.
* `op` – тип события. Может иметь значения `added` (пользователь добавлен в
  список администраторов), `removed` (пользователь удален из списка
  администраторов) и `check` (скрипт мониторинга успешно выполнил проверки).

События с `op=added` или `op=removed` дополнительно содержат:

* `group_id` – идентификатор группы VK, к которой относится событие. Наличие
  этого поля позволяет записывать события, относящиеся к различным группам, в
  один индекс Splunk.
* `id` – идентификатор пользователя VK, к которому относится событие.
* `role` – административная роль пользователя в группе (после добавления или
  перед удалением).
* `display_name` – отображаемое имя пользователя VK, к которому относится
  событие.

События с типом `op=check` предназначены для мониторинга работоспособности
системы: отсутствие таких событий в течение длительного времени (больше
длительности цикла мониторинга) свидетельствует о наличии проблем. Для выявления
проблем может использоваться, например, такой запрос в Splunk:

```
index="vkgrpmon" op="check"
| stats latest(_time) as latest by host
| where latest < relative_time(now(), "-15m")
```

## Интеграция с Slack

Выбор Slack обусловлен простотой интеграции и наличием удобных средств
форматирования сообщений. Нотификации отправляются через Webhook API без
использования сторонних библиотек. Для форматирования текста применяется
Markdown.

Каждая нотификация содержит все изменения в списке администраторов группы VK,
обнаруженные в рамках цикла мониторинга, то есть при удалении или добавлении
нескольких пользователей будет создано только одно сообщение.

В случае, если никаких изменений не обнаружено, нотификация не отправляется.

# Особенности программной реализации

Программная логика реализована в файле `./monitor/vkgrpmon.py`. Код написан на
языке Python 3 с использованием минимального количества сторонних библиотек.

Поскольку скрипт рассчитан на работу в контейнерах Docker, параметры работы
скрипта, в том числе секреты, передаются через переменные окружения.

Взаимодействие с внешними системами инкапсулированно в отдельных классах, что
облегчает дальнейшую поддержку кодовой базы и при необходимости позволяет
использовать эти классы повторно.

Автоматизированные тесты содержатся в файле `./monitor/vkgrpmon.py`, тестовое
покрытие составляет 79%. Предполагается, что тесты будут запускаться в
CI/CD-конвейере.

# Контейнеризация

Система состоит из двух Docker-контейнеров: Monitor и Splunk. В первом
контейнере запускается логика мониторинга, во втором -- Splunk. В случае, если в
организации уже имеется развернутая система Splunk, Monitor может отправлять
нотификации в нее; запуск контейнера Splunk в таком случае не требуется.

## Контейнер Monitor

Легковесный контейнер на базе Alpine Linux с установленным Python 3.

Скрипт мониторинга `vkgrpmon.py` запускается по `cron` от имени
пользователя `vkgrpmon:vkgrpmon` с обычными правами доступа. Периодичность
запуска настраивается в файле `./monitor/crontab` (изменения требуют пересборки
контейнера).

Между запусками скрипта состояние сохраняется в директории
`/var/lib/vkgrpmon` контейнера. Удаление этих данных приведет к тому, что при
следующем запуске скрипта мониторинга все администраторы группы будут считаться
новыми.

При нормальной работе контейнер ничего не выводит в консоль. Наличие данных в
консоли свидетельствует о нештатной ситуации и может использоваться для
мониторинга.

Настроечные параметры передаются через переменные окружения:

* `SPLUNK_ADDRESS` – адрес, на который будут отправляться события для Splunk.
* `VK_ACCESS_TOKEN` – ключ доступа к VK API с правами на получение списка
  администраторов группы.
* `VK_GROUP_ID` – числовой идентификатор группы VK, для которой будет
  выполняться мониторинг списка администраторов.
* `SLACK_WEBHOOK_URL` – URL для отправки нотификаций в Slack через Webhook API.

## Контейнер Splunk

Контейнер на базе официального Docker-образа Splunk 8. Веб-интерфейс Splunk
доступен на порту 8000 по протоколу HTTP.

Настройки Splunk, необходимые для приема и индексации событий, вынесены в
отдельное приложение `vkgrpmon`, что упрощает их поддержку и при необходимости
обеспечивает простое развертывание на других исталляциях Splunk. Приложение
устанавливается в Splunk при сборке контейнера.

Для приема событий используется простой TCP input, слушающий порт 9999. Для
разбора событий настроен sourcetype `vkgrpmon`. События сохраняются в отдельном
индексе `vkgrpmon` с настройками по умолчанию.

Настроечные параметры контейнера передаются через переменные окружения:

* `SPLUNK_START_ARGS` – парамеры командной строки для запуска Splunk. Переменная
  должна обязательно содержать ключ `--accept-license` (поскольку принятие
  лицензии является юридически обязывающим действием, этот ключ не может быть
  встроен в Docker-образ).
* `SPLUNK_PASSWORD` – пароль для административной учетной записи `admin` в
  Splunk.

## Запуск контейнеров

Перед запуском необходимо настроить параметры системы, задав значения переменных
окружения в файле `.env` в корне проекта. Переменная `SPLUNK_ADDRESS` по
умолчанию уже содержит правильный адрес экземпляра Splunk, поэтому ее указывать
не нужно.

Запуск системы осуществляется при помощи команды `docker-compose up`. После
запуска интерфейс Splunk доступен по адресу `http://localhost:8000`, для входа
используется учетная запись `admin` и пароль, указанный в переменной
окружения `SPLUNK_PASSWORD`.

Для остановки контейнеров используется сочетание клавиш `Ctrl+C`. Удалить
созданные при запуске контейнеры и сети можно командой `docker-compose down`.
